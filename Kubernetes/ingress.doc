1. Cài ingress-nginx trên cluster

kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/baremetal/deploy.yaml
#đợi chạy xong

kubectl -n ingress-nginx get pods -o wide
-> sẽ thấy pod ingress-nginx-controller- running
#mặc định thường chỉ chạy 1 replica

2. Cho controller chạy trên cả 3 worker
Sửa Deployment:
kubectl -n ingress-nginx edit deploy ingress-nginx-controller

Trong spec:
spec:
  replicas: 3
  template:
    spec:
      nodeSelector:
        kubernetes.io/role: worker   # nếu m có label worker
      # hoặc bỏ nodeSelector, để scheduler tự dàn ra 3 node khác nhau

#Lưu rồi kiểm tra:
kubectl -n ingress-nginx get pods -o wide

#phải có 3 pod controller, mỗi pod nằm trên 1 worker khác nhau

3. Expose ingress controller bằng nodeport
#kiểm tra service:
kubectl -n ingress-nginx get svc ingress-nginx-controller -o yaml
#sửa
kubectl -n ingress-nginx edit svc ingress-nginx-controller

#trong spec:
spec:
  type: NodePort
  ports:
    - name: http
      port: 80
      targetPort: http
      nodePort: 30080       # m chọn 30080
    - name: https
      port: 443
      targetPort: https
      nodePort: 30443       # m chọn 30443

#giờ cả 3 worker sẽ nghe:
    HTTP ingress: workerIP:30080.

    HTTPS ingress: workerIP:30443.

Test nhanh: từ ngoài, curl thẳng 1 node (chưa có rule Ingress thì 404/nginx default).

4. Cấu hình HAProxy làm LB trước 3 ingress
#Trên cụm HAProxy ngoài(có thể 3 master + Keepalived, giống cluster API), tạo thêm frontend/backend cho HTTP/HTTPS

Ví dụ trong /etc/haproxy/haproxy.cfg
frontend http_ingress
  bind 10.3.2.210:80
  mode tcp
  option tcplog
  default_backend http_ingress_back

backend http_ingress_back
  mode tcp
  balance roundrobin
  option tcp-check
  server w1 10.3.2.211:30080 check
  server w2 10.3.2.212:30080 check
  server w3 10.3.2.213:30080 check

frontend https_ingress
  bind 10.3.2.210:443
  mode tcp
  option tcplog
  default_backend https_ingress_back

backend https_ingress_back
  mode tcp
  balance roundrobin
  option tcp-check
  server w1 10.3.2.211:30443 check
  server w2 10.3.2.212:30443 check
  server w3 10.3.2.213:30443 check

#Rồi restart HAProxy
sudo haproxy -c -f /etc/haproxy/haproxy.cfg   # check config
sudo systemctl restart haproxy
sudo systemctl status haproxy

#Flow bây giờ
- Client -> 10.3.2.210:80/443 (VIP web)
- HAproxy chia đều về workerIP:30080/30443
- Pod ingress-nginx trên worker đó nhận request, nhìn ingress rule và route vào service/pod

5. Tạo app + Ingress để test
#App demo:
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: web-demo
  template:
    metadata:
      labels:
        app: web-demo
    spec:
      containers:
        - name: web
          image: nginx
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: web-demo-svc
spec:
  selector:
    app: web-demo
  ports:
    - port: 80
      targetPort: 80

#Ingress:
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web-demo-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
spec:
  rules:
    - host: web.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: web-demo-svc
                port:
                  number: 80

#Apply:
kubectl apply -f web-demo.yaml
kubectl apply -f web-demo-ingress.yaml

#Trên máy client, thêm vào /etc/hosts:
10.3.2.210  web.local

#Test:
curl http://web.local

→ request đi: client → 10.3.2.210:80 → HAProxy → 1 trong 3 worker (NodePort 30080) → ingress‑nginx → web-demo-svc → pod NGINX.

